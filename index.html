<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Devis Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #e0e7ff;
            --secondary: #3a0ca3;
            --accent: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --border-radius: 8px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7ff;
            color: var(--dark);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }
        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(30deg);
        }
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            position: relative;
        }
        header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
        }
        .app-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        @media (max-width: 992px) {
            .app-grid {
                grid-template-columns: 1fr;
            }
        }
        .panel {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1.5rem;
            height: fit-content;
            transition: var(--transition);
        }
        .panel:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        .panel h2 {
            color: var(--secondary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.8rem;
            border-bottom: 2px solid var(--light-gray);
            display: flex;
            align-items: center;
            font-size: 1.4rem;
        }
        .panel h2 i {
            margin-right: 0.8rem;
            color: var(--accent);
            font-size: 1.2rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
            font-size: 0.95rem;
        }
        input, select, textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: 1rem;
            transition: var(--transition);
            background-color: white;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        textarea {
            min-height: 100px;
            resize: vertical;
            line-height: 1.5;
        }
        .items-container {
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        .items-header {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 1fr 0.5fr;
            background-color: var(--light);
            padding: 0.8rem 1rem;
            font-weight: 600;
            border-bottom: 1px solid var(--light-gray);
            font-size: 0.9rem;
        }
        .item-row {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 1fr 0.5fr;
            padding: 0.8rem 1rem;
            align-items: center;
            border-bottom: 1px solid var(--light-gray);
            transition: var(--transition);
        }
        .item-row:hover {
            background-color: var(--primary-light);
        }
        .item-row:last-child {
            border-bottom: none;
        }
        .item-row input {
            padding: 0.6rem;
            width: calc(100% - 0.5rem);
            background-color: transparent;
            border: 1px solid transparent;
        }
        .item-row input:focus {
            border-color: var(--accent);
            background-color: white;
        }
        .item-total-value {
            font-weight: 500;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }
        .btn i {
            margin-right: 0.5rem;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: #3a56d8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
        }
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        .btn-warning:hover {
            background-color: #e07e0c;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(248, 150, 30, 0.2);
        }
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        .btn-danger:hover {
            background-color: #e3175a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(247, 37, 133, 0.2);
        }
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--gray);
            color: var(--dark);
        }
        .btn-outline:hover {
            background-color: var(--light);
            transform: translateY(-2px);
        }
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        .btn-xs {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }
        .actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }
        .quote-preview {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }
        .quote-preview:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        .quote-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .quote-title {
            font-size: 1.8rem;
            color: var(--secondary);
            font-weight: 700;
        }
        .quote-meta {
            text-align: right;
        }
        .quote-meta div {
            margin-bottom: 0.3rem;
        }
        .quote-client {
            margin-bottom: 2rem;
            background-color: var(--light);
            padding: 1.2rem;
            border-radius: var(--border-radius);
        }
        .quote-client h3 {
            margin-bottom: 0.8rem;
            color: var(--secondary);
        }
        .quote-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }
        .quote-table th {
            background-color: var(--light);
            padding: 0.8rem;
            text-align: left;
            border-bottom: 2px solid var(--light-gray);
            font-weight: 600;
        }
        .quote-table td {
            padding: 0.8rem;
            border-bottom: 1px solid var(--light-gray);
        }
        .quote-totals {
            width: 100%;
            max-width: 300px;
            margin-left: auto;
            margin-bottom: 2rem;
        }
        .quote-totals td {
            padding: 0.6rem 0;
        }
        .quote-totals tr:last-child td {
            font-weight: 600;
            font-size: 1.1rem;
            border-top: 2px solid var(--light-gray);
            padding-top: 0.8rem;
        }
        .quote-notes {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--light-gray);
            background-color: var(--light);
            padding: 1.2rem;
            border-radius: var(--border-radius);
        }
        .quote-notes h3 {
            margin-bottom: 0.8rem;
            color: var(--secondary);
        }
        footer {
            text-align: center;
            padding: 1.5rem;
            color: var(--gray);
            font-size: 0.9rem;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            transform: translateY(100px);
            opacity: 0;
            transition: var(--transition);
            z-index: 1000;
            display: flex;
            align-items: center;
        }
        .toast i {
            margin-right: 0.8rem;
            font-size: 1.2rem;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        .toast.error {
            background-color: var(--danger);
        }
        .toast.warning {
            background-color: var(--warning);
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--light-gray);
        }
        .modal-title {
            font-size: 1.5rem;
            color: var(--secondary);
            display: flex;
            align-items: center;
        }
        .modal-title i {
            margin-right: 0.8rem;
            color: var(--accent);
        }
        .close {
            color: var(--gray);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }
        .close:hover {
            color: var(--dark);
            transform: rotate(90deg);
        }
        .quotes-list {
            flex: 1;
            overflow-y: auto;
            margin: 1rem 0;
            padding-right: 0.5rem;
        }
        .quote-item {
            padding: 1.2rem;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            cursor: pointer;
            transition: var(--transition);
            background-color: white;
        }
        .quote-item:hover {
            background-color: var(--primary-light);
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.1);
        }
        .quote-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            align-items: center;
        }
        .quote-item-number {
            font-weight: 600;
            color: var(--secondary);
            font-size: 1.1rem;
        }
        .quote-item-date {
            color: var(--gray);
            font-size: 0.85rem;
        }
        .quote-item-client {
            font-weight: 500;
            margin-bottom: 0.3rem;
        }
        .quote-item-total {
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
        }
        .quote-item-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.8rem;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--light-gray);
        }
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
        }
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--light-gray);
        }
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .items-header, .item-row {
                grid-template-columns: 2fr 1fr 1fr 1fr 0.5fr;
            }
            .form-row {
                flex-direction: column;
                gap: 1rem;
            }
            .actions {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
        }
        @media (max-width: 576px) {
            .container {
                padding: 1rem;
            }
            header {
                padding: 1.5rem 1rem;
            }
            header h1 {
                font-size: 2rem;
            }
            .panel {
                padding: 1rem;
            }
            .items-header, .item-row {
                grid-template-columns: 1.5fr 1fr 1fr 1fr 0.5fr;
                font-size: 0.8rem;
                padding: 0.6rem;
            }
            .item-row input {
                font-size: 0.8rem;
                padding: 0.4rem;
            }
            .quote-preview {
                padding: 1rem;
            }
            .quote-header {
                flex-direction: column;
            }
            .quote-meta {
                text-align: left;
            }
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--light);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--gray);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--dark);
        }
        /* Styles pour le flou */
        #blur-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            backdrop-filter: blur(8px);
            z-index: 1000;
            pointer-events: none; /* Permet de cliquer à travers */
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        #blur-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        body.blur-active {
            overflow: hidden; /* Empêche le scroll quand le flou est actif */
        }
        /* Styles pour l'éditeur de texte riche */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem;
            background-color: var(--light);
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            border-bottom: none;
        }
        .toolbar button {
            background: white;
            border: 1px solid var(--light-gray);
            border-radius: 4px;
            padding: 0.3rem 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .toolbar button:hover {
            background-color: var(--light-gray);
        }
        .toolbar button.active {
            background-color: var(--primary);
            color: white;
        }
        #notes-container {
            position: relative;
        }
        #notes {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            min-height: 150px;
            padding: 1rem;
            border: 1px solid var(--light-gray);
            border-top: none;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
        }
        #notes:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        /* Palette de couleurs */
        .color-picker {
            position: absolute;
            background: white;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            padding: 0.5rem;
            box-shadow: var(--box-shadow);
            z-index: 1000;
            display: none; /* Initialement cachée */
        }
        .color-option {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin: 0.2rem;
            cursor: pointer;
            border: 1px solid #ddd;
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        /* Styles pour l'aperçu des notes */
        #preview-notes {
            white-space: pre-wrap;
            line-height: 1.5;
        }
    </style>
</head>
<body class="blur-active">
    <!-- Overlay de flou -->
    <div id="blur-overlay"></div>
    <header>
        <h1><i class="fas fa-file-invoice"></i> Générateur de Devis Professionnel</h1>
        <p>Créez, enregistrez et exportez vos devis en PDF</p>
        <div id="user-info" style="position: absolute; top: 10px; right: 20px; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 20px; font-size: 0.9rem; display: none;"></div>
        <button id="auth-button" class="btn btn-outline" style="position: absolute; top: 10px; left: 20px;">
            <i class="fas fa-sign-in-alt"></i> Connexion
        </button>
    </header>
    <div class="container">
        <div class="app-grid">
            <div class="panel">
                <h2><i class="fas fa-edit"></i> Création du Devis</h2>
                <div class="form-group">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="quote-number">Numéro de devis</label>
                            <input type="text" id="quote-number" placeholder="DEV-2023-001">
                        </div>
                        <div class="form-group">
                            <label for="quote-date">Date</label>
                            <input type="date" id="quote-date">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="validity">Validité (jours)</label>
                            <input type="number" id="validity" value="30" min="1">
                        </div>
                        <div class="form-group">
                            <label for="currency">Devise</label>
                            <select id="currency">
                                <option value="€">EUR (€)</option>
                                <option value="$">USD ($)</option>
                                <option value="DT" selected>TND (DT)</option>
                                <option value="£">GBP (£)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <h2><i class="fas fa-user-tie"></i> Informations Client</h2>
                    <div class="form-group">
                        <label for="client-name">Nom du client</label>
                        <input type="text" id="client-name" placeholder="Entreprise Client">
                    </div>
                    <div class="form-group">
                        <label for="client-address">Adresse</label>
                        <textarea id="client-address" rows="2" placeholder="123 Rue Principale, Ville"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="client-email">Email</label>
                            <input type="email" id="client-email" placeholder="contact@client.com">
                        </div>
                        <div class="form-group">
                            <label for="client-phone">Téléphone</label>
                            <input type="tel" id="client-phone" placeholder="+216 12 345 678">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <h2><i class="fas fa-boxes"></i> Articles</h2>
                    <div class="items-container">
                        <div class="items-header">
                            <span>Description</span>
                            <span>Quantité</span>
                            <span>Prix unitaire</span>
                            <span>Total</span>
                            <span></span>
                        </div>
                        <div id="items-list">
                            <!-- Items will be added here -->
                        </div>
                    </div>
                    <button id="add-item" class="btn btn-primary" style="margin-top: 1rem;">
                        <i class="fas fa-plus"></i> Ajouter un article
                    </button>
                </div>
                <div class="form-group">
                    <h2><i class="fas fa-percentage"></i> Taxes & Remises</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="discount">Remise (%)</label>
                            <input type="number" id="discount" value="0" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label for="tax">TVA (%)</label>
                            <input type="number" id="tax" value="19" min="0">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <h2><i class="fas fa-comment-dots"></i> Notes</h2>
                    <!-- Toolbar for rich text editing -->
                    <div class="toolbar">
                        <button id="bold-btn" title="Gras"><i class="fas fa-bold"></i></button>
                        <button id="italic-btn" title="Italique"><i class="fas fa-italic"></i></button>
                        <button id="underline-btn" title="Souligné"><i class="fas fa-underline"></i></button>
                        <button id="bullet-list-btn" title="Liste à puces"><i class="fas fa-list-ul"></i></button>
                        <button id="number-list-btn" title="Liste numérotée"><i class="fas fa-list-ol"></i></button>
                        <button id="align-left-btn" title="Aligner à gauche"><i class="fas fa-align-left"></i></button>
                        <button id="align-center-btn" title="Centrer"><i class="fas fa-align-center"></i></button>
                        <button id="align-right-btn" title="Aligner à droite"><i class="fas fa-align-right"></i></button>
                    </div>
                    <div id="notes-container">
                        <div id="notes" contenteditable="true" placeholder="Conditions de paiement, informations supplémentaires..."></div>
                        <!-- Palette de couleurs -->
                        <div id="color-picker" class="color-picker">
                            <div class="color-option" style="background-color: #000000;" data-color="#000000"></div>
                            <div class="color-option" style="background-color: #ff0000;" data-color="#ff0000"></div>
                            <div class="color-option" style="background-color: #00ff00;" data-color="#00ff00"></div>
                            <div class="color-option" style="background-color: #0000ff;" data-color="#0000ff"></div>
                            <div class="color-option" style="background-color: #ffff00;" data-color="#ffff00"></div>
                            <div class="color-option" style="background-color: #00ffff;" data-color="#00ffff"></div>
                            <div class="color-option" style="background-color: #ff00ff;" data-color="#ff00ff"></div>
                            <div class="color-option" style="background-color: #ffffff; border: 1px solid #ccc;" data-color="#ffffff"></div>
                            <div class="color-option" style="background-color: #ff9900;" data-color="#ff9900"></div>
                            <div class="color-option" style="background-color: #9900ff;" data-color="#9900ff"></div>
                        </div>
                    </div>
                </div>
                <div class="actions">
                    <button id="load-quote" class="btn btn-outline">
                        <i class="fas fa-folder-open"></i> Charger
                    </button>
                    <button id="save-quote" class="btn btn-success">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                    <button id="update-quote" class="btn btn-warning" style="display: none;">
                        <i class="fas fa-sync-alt"></i> Mettre à jour
                    </button>
                    <button id="generate-pdf" class="btn btn-primary">
                        <i class="fas fa-file-pdf"></i> Générer PDF
                    </button>
                    <button id="reset-form" class="btn btn-danger">
                        <i class="fas fa-trash-alt"></i> Réinitialiser
                    </button>
                </div>
            </div>
            <div class="panel">
                <h2><i class="fas fa-eye"></i> Aperçu du Devis</h2>
                <div id="quote-preview" class="quote-preview">
                    <div class="quote-header">
                        <div class="quote-title">DEVIS</div>
                        <div class="quote-meta">
                            <div><strong>N°:</strong> <span id="preview-number">DEV-2023-001</span></div>
                            <div><strong>Date:</strong> <span id="preview-date">01/01/2023</span></div>
                            <div><strong>Validité:</strong> <span id="preview-validity">30 jours</span></div>
                        </div>
                    </div>
                    <div class="quote-client">
                        <h3>Client</h3>
                        <div id="preview-client-name">Entreprise Client</div>
                        <div id="preview-client-address">123 Rue Principale, Ville</div>
                        <div id="preview-client-contact">contact@client.com | +216 12 345 678</div>
                    </div>
                    <table class="quote-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Quantité</th>
                                <th>Prix unitaire</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="preview-items">
                            <!-- Items will be added here -->
                        </tbody>
                    </table>
                    <table class="quote-totals">
                        <tr>
                            <td>Sous-total:</td>
                            <td id="preview-subtotal">0.00 DT</td>
                        </tr>
                        <tr>
                            <td>Remise (<span id="preview-discount-rate">0</span>%):</td>
                            <td id="preview-discount">-0.00 DT</td>
                        </tr>
                        <tr>
                            <td>TVA (<span id="preview-tax-rate">19</span>%):</td>
                            <td id="preview-tax">+0.00 DT</td>
                        </tr>
                        <tr>
                            <td><strong>Total:</strong></td>
                            <td id="preview-total"><strong>0.00 DT</strong></td>
                        </tr>
                    </table>
                    <div class="quote-notes">
                        <h3>Notes</h3>
                        <div id="preview-notes">Aucune note spécifiée.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal pour charger les devis existants -->
    <div id="quotesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-folder-open"></i> Devis enregistrés</h2>
                <span class="close">&times;</span>
            </div>
            <div id="quotes-list" class="quotes-list">
                <!-- Liste des devis sera ajoutée ici -->
            </div>
            <div class="modal-actions">
                <button id="cancel-load" class="btn btn-danger">Fermer</button>
            </div>
        </div>
    </div>
<footer>
    <p>© <span id="current-year"></span> Générateur de Devis Professionnel | Tous droits réservés à A³I</p>
</footer>
<script>
    // Afficher l'année en cours dans le footer
    document.getElementById('current-year').textContent = new Date().getFullYear();
</script>
    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span class="toast-message"></span>
    </div>
    <!-- Modal de connexion -->
    <div id="loginModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-sign-in-alt"></i> Connexion</h2>
                <span class="close" onclick="closeLoginModal()">&times;</span>
            </div>
            <div class="form-group" style="padding: 1.5rem;">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" placeholder="votre@email.com">
                </div>
                <div class="form-group">
                    <label for="login-password">Mot de passe</label>
                    <input type="password" id="login-password" placeholder="Votre mot de passe">
                </div>
                <div id="login-error" style="color: var(--danger); margin: 1rem 0; display: none;"></div>
                <div class="modal-actions">
                    <button id="login-submit" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Se connecter
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAdjb7XIpEky9b_FcgNS0TLgjl7VQEW9qs",
            authDomain: "gestionprojet-coach.firebaseapp.com",
            databaseURL: "https://gestionprojet-coach-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gestionprojet-coach",
            storageBucket: "gestionprojet-coach.appspot.com",
            messagingSenderId: "42128207267",
            appId: "1:42128207267:web:156f6e73222fe8eebb3e16"
        };
        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();
        const auth = firebase.auth(); // Ajout du service d'authentification
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        // Current quote ID for update
        let currentQuoteId = null;
        // État d'authentification
        let currentUser = null;
        // Références aux éléments
        const blurOverlay = document.getElementById('blur-overlay');
        const colorPicker = document.getElementById('color-picker');
        let isColorPickerVisible = false;
        // Vérifier l'état de connexion au chargement
        auth.onAuthStateChanged(user => {
            currentUser = user;
            updateAuthUI();
            if (user) {
                // Utilisateur connecté - retirer le flou
                document.body.classList.remove('blur-active');
                blurOverlay.classList.add('hidden');
                console.log("Utilisateur connecté:", user.email);
            } else {
                // Utilisateur non connecté - appliquer le flou et ouvrir la modale
                document.body.classList.add('blur-active');
                blurOverlay.classList.remove('hidden');
                showLoginModal();
                console.log("Utilisateur déconnecté");
            }
        });
        // Mettre à jour l'UI en fonction de l'état d'authentification
        function updateAuthUI() {
            const authBtn = document.getElementById('auth-button');
            const userInfo = document.getElementById('user-info');
            if (currentUser) {
                authBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Déconnexion';
                authBtn.onclick = logout;
                userInfo.textContent = `Connecté: ${currentUser.email}`;
                userInfo.style.display = 'block';
            } else {
                authBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Connexion';
                authBtn.onclick = showLoginModal;
                userInfo.style.display = 'none';
            }
        }
        // Fonction de connexion
        function login(email, password) {
            return auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    console.error("Erreur de connexion:", error);
                    throw error;
                });
        }
        // Fonction de déconnexion
        function logout() {
            if (confirm('Voulez-vous vraiment vous déconnecter ?')) {
                return auth.signOut()
                    .then(() => {
                        showToast('Déconnexion réussie');
                        currentQuoteId = null;
                        toggleUpdateButton(false);
                        resetForm(); // Réinitialiser le formulaire à la déconnexion
                    })
                    .catch(error => {
                        console.error("Erreur de déconnexion:", error);
                        showToast('Erreur lors de la déconnexion', 'error');
                    });
            }
        }
        // Gestion de la modale de connexion
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
        }
        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('login-error').style.display = 'none';
        }
        // Gestion de la soumission du formulaire
        document.getElementById('login-submit').addEventListener('click', () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');
            if (!email || !password) {
                errorElement.textContent = 'Veuillez remplir tous les champs';
                errorElement.style.display = 'block';
                return;
            }
            login(email, password)
                .then(() => {
                    closeLoginModal();
                    showToast('Connexion réussie!');
                })
                .catch(error => {
                    let errorMessage = "Erreur de connexion";
                    if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        errorMessage = "Email ou mot de passe incorrect";
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = "Trop de tentatives. Compte temporairement bloqué";
                    } else {
                        errorMessage = error.message; // Afficher le message d'erreur Firebase par défaut
                    }
                    errorElement.textContent = errorMessage;
                    errorElement.style.display = 'block';
                });
        });
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('quote-date').value = today;
            updatePreview();
            // Add item button
            document.getElementById('add-item').addEventListener('click', addNewItem);
            // Generate PDF button
            document.getElementById('generate-pdf').addEventListener('click', generatePDF);
            // Save quote button
            document.getElementById('save-quote').addEventListener('click', saveQuote);
            // Update quote button
            document.getElementById('update-quote').addEventListener('click', updateQuote);
            // Load quote button
            document.getElementById('load-quote').addEventListener('click', openQuotesModal);
            // Reset form button
            document.getElementById('reset-form').addEventListener('click', resetForm);
            // Modal close buttons
            document.querySelector('.close').addEventListener('click', closeQuotesModal);
            document.getElementById('cancel-load').addEventListener('click', closeQuotesModal);
            // Input event listeners for live preview
            const inputs = [
                'quote-number', 'quote-date', 'validity', 'currency',
                'client-name', 'client-address', 'client-email', 'client-phone',
                'discount', 'tax'
            ];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', updatePreview);
            });
            // Add initial item
            addNewItem();
            // Rich text editor buttons
            document.getElementById('bold-btn').addEventListener('click', () => formatText('bold'));
            document.getElementById('italic-btn').addEventListener('click', () => formatText('italic'));
            document.getElementById('underline-btn').addEventListener('click', () => formatText('underline'));
            document.getElementById('bullet-list-btn').addEventListener('click', () => insertList('ul'));
            document.getElementById('number-list-btn').addEventListener('click', () => insertList('ol'));
            document.getElementById('align-left-btn').addEventListener('click', () => alignText('left'));
            document.getElementById('align-center-btn').addEventListener('click', () => alignText('center'));
            document.getElementById('align-right-btn').addEventListener('click', () => alignText('right'));
            // Color picker options
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    const color = this.getAttribute('data-color');
                    document.execCommand('foreColor', false, color);
                    document.getElementById('notes').focus();
                    // Fermer la palette après sélection
                    colorPicker.style.display = 'none';
                    isColorPickerVisible = false;
                    // S'assurer que l'écouteur temporaire est retiré
                    document.removeEventListener('click', handleDocumentClickForColorPicker);
                });
            });
            // Update preview when notes change
            document.getElementById('notes').addEventListener('input', updatePreview);
        });
        // Fonction gestionnaire dédiée pour fermer la palette via le document
        function handleDocumentClickForColorPicker(e) {
            // Vérifier que la palette est censée être visible
            // et que le clic n'est ni sur le bouton ni dans la palette
            if (isColorPickerVisible &&
                e.target !== document.getElementById('color-btn') &&
                !colorPicker.contains(e.target)) {

                colorPicker.style.display = 'none';
                isColorPickerVisible = false;
                // Retirer cet écouteur spécifique après utilisation
                document.removeEventListener('click', handleDocumentClickForColorPicker);
            }
        }
        // Fonction pour basculer l'affichage de la palette de couleurs
        function toggleColorPicker(event) {
            // Empêcher la propagation du clic pour éviter d'autres gestionnaires
            event.stopPropagation();

            const colorBtn = document.getElementById('color-btn');
            const rect = colorBtn.getBoundingClientRect();

            if (isColorPickerVisible) {
                // Si la palette est visible, la cacher
                colorPicker.style.display = 'none';
                isColorPickerVisible = false;
                // Retirer l'écouteur temporaire s'il existe
                document.removeEventListener('click', handleDocumentClickForColorPicker);
            } else {
                // Si la palette est cachée, la montrer
                colorPicker.style.display = 'block';
                // Positionne la palette sous le bouton
                colorPicker.style.top = (rect.bottom + window.scrollY) + 'px';
                colorPicker.style.left = (rect.left + window.scrollX) + 'px';
                isColorPickerVisible = true;

                // Ajouter un écouteur temporaire sur le document pour fermer la palette
                // lors du prochain clic en dehors, en utilisant setTimeout pour éviter
                // qu'il ne capture le clic actuel.
                setTimeout(() => {
                    document.addEventListener('click', handleDocumentClickForColorPicker);
                }, 0);
            }
        }
        // Fermer la modale si on clique en dehors - CORRIGE
        window.onclick = function(event) {
          // Fermer la modale de login si on clique en dehors ET que l'utilisateur est connecté
          if (event.target == document.getElementById('loginModal')) {
            if (currentUser) { // Ne ferme que si l'utilisateur est connecté
              closeLoginModal();
            }
            return; // Important: sortir après avoir géré la modale
          }

          // *** GESTION DE LA PALETTE DE COULEURS ***
          // La logique de fermeture est maintenant gérée par toggleColorPicker et handleDocumentClickForColorPicker
          // Cette section est laissée vide intentionnellement ou peut contenir d'autres vérifications.
          // *** FIN GESTION DE LA PALETTE DE COULEURS ***
        }
        // Rich text editor functions
        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('notes').focus();
        }
        function insertList(type) {
            if (type === 'ul') {
                document.execCommand('insertUnorderedList', false, null);
            } else {
                document.execCommand('insertOrderedList', false, null);
            }
            document.getElementById('notes').focus();
        }
        function alignText(align) {
            document.execCommand(`justify${align}`, false, null);
            document.getElementById('notes').focus();
        }
        function addNewItem() {
            const itemsList = document.getElementById('items-list');
            const itemCount = itemsList.children.length + 1;
            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.innerHTML = `
                <div class="item-desc">
                    <input type="text" class="item-description" placeholder="Description de l'article ${itemCount}" value="Article ${itemCount}">
                </div>
                <div class="item-qty">
                    <input type="number" class="item-quantity" value="1" min="1">
                </div>
                <div class="item-price">
                    <input type="number" class="item-unit-price" value="100" min="0" step="0.01">
                </div>
                <div class="item-total">
                    <span class="item-total-value">100.00</span> <span class="currency">DT</span>
                </div>
                <div class="item-action">
                    <button class="btn btn-danger btn-sm remove-item"><i class="fas fa-trash"></i></button>
                </div>
            `;
            itemsList.appendChild(itemRow);
            // Add events for automatic calculation
            const quantityInput = itemRow.querySelector('.item-quantity');
            const priceInput = itemRow.querySelector('.item-unit-price');
            const calculateTotal = () => {
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const total = quantity * price;
                itemRow.querySelector('.item-total-value').textContent = total.toFixed(2);
                updatePreview();
            };
            quantityInput.addEventListener('input', calculateTotal);
            priceInput.addEventListener('input', calculateTotal);
            // Add event to remove item
            itemRow.querySelector('.remove-item').addEventListener('click', function() {
                itemsList.removeChild(itemRow);
                updatePreview();
            });
            updatePreview();
        }
        function updatePreview() {
            // Update header information
            document.getElementById('preview-number').textContent = document.getElementById('quote-number').value || 'DEV-0000';
            const dateValue = document.getElementById('quote-date').value;
            if (dateValue) {
                const date = new Date(dateValue);
                document.getElementById('preview-date').textContent = date.toLocaleDateString('fr-FR');
            }
            document.getElementById('preview-validity').textContent =
                `${document.getElementById('validity').value || 0} jours`;
            // Update client information
            document.getElementById('preview-client-name').textContent =
                document.getElementById('client-name').value || 'Non spécifié';
            document.getElementById('preview-client-address').textContent =
                document.getElementById('client-address').value || 'Non spécifié';
            const clientEmail = document.getElementById('client-email').value || '';
            const clientPhone = document.getElementById('client-phone').value || '';
            document.getElementById('preview-client-contact').textContent =
                `${clientEmail}${clientEmail && clientPhone ? ' | ' : ''}${clientPhone}`;
            // Update items
            const previewItems = document.getElementById('preview-items');
            previewItems.innerHTML = '';
            const currency = document.getElementById('currency').value;
            const itemsList = document.getElementById('items-list');
            let subtotal = 0;
            Array.from(itemsList.children).forEach(itemRow => {
                const description = itemRow.querySelector('.item-description').value || 'Article';
                const quantity = parseFloat(itemRow.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(itemRow.querySelector('.item-unit-price').value) || 0;
                const total = quantity * price;
                subtotal += total;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${description}</td>
                    <td>${quantity}</td>
                    <td>${price.toFixed(2)} ${currency}</td>
                    <td>${total.toFixed(2)} ${currency}</td>
                `;
                previewItems.appendChild(row);
            });
            // Update totals
            const discountRate = parseFloat(document.getElementById('discount').value) || 0;
            const discountAmount = subtotal * discountRate / 100;
            const taxRate = parseFloat(document.getElementById('tax').value) || 0;
            const taxAmount = (subtotal - discountAmount) * taxRate / 100;
            const total = subtotal - discountAmount + taxAmount;
            document.getElementById('preview-subtotal').textContent =
                `${subtotal.toFixed(2)} ${currency}`;
            document.getElementById('preview-discount-rate').textContent = discountRate;
            document.getElementById('preview-discount').textContent =
                `-${discountAmount.toFixed(2)} ${currency}`;
            document.getElementById('preview-tax-rate').textContent = taxRate;
            document.getElementById('preview-tax').textContent =
                `+${taxAmount.toFixed(2)} ${currency}`;
            document.getElementById('preview-total').innerHTML =
                `<strong>${total.toFixed(2)} ${currency}</strong>`;
            // Update notes
            const notesContent = document.getElementById('notes').innerHTML;
            document.getElementById('preview-notes').innerHTML = notesContent || 'Aucune note spécifiée.';
            // Update currency symbols
            document.querySelectorAll('.currency').forEach(el => {
                el.textContent = currency;
            });
        }
        function generatePDF() {
            const doc = new jsPDF();
            // Get data from preview
            const quoteNumber = document.getElementById('preview-number').textContent;
            const quoteDate = document.getElementById('preview-date').textContent;
            const quoteValidity = document.getElementById('preview-validity').textContent;
            const clientName = document.getElementById('preview-client-name').textContent;
            const clientAddress = document.getElementById('preview-client-address').textContent;
            const clientContact = document.getElementById('preview-client-contact').textContent;
            const currency = document.getElementById('currency').value;
            const subtotal = document.getElementById('preview-subtotal').textContent;
            const discountRate = document.getElementById('preview-discount-rate').textContent;
            const discountAmount = document.getElementById('preview-discount').textContent;
            const taxRate = document.getElementById('preview-tax-rate').textContent;
            const taxAmount = document.getElementById('preview-tax').textContent;
            const total = document.getElementById('preview-total').textContent;
            // Set font
            doc.setFont("helvetica");
            // Add company header
            doc.setFillColor(67, 97, 238); // Primary color
            doc.rect(0, 0, 210, 30, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('DEVIS', 105, 20, { align: 'center' });
            // Add quote info
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`N°: ${quoteNumber}`, 150, 40);
            doc.text(`Date: ${quoteDate}`, 150, 48);
            doc.text(`Validité: ${quoteValidity}`, 150, 56);
            // Add client info
            doc.setFillColor(248, 249, 250); // Light gray
            doc.rect(10, 65, 190, 30, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Client', 15, 75);
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(clientName, 15, 85);
            doc.text(clientAddress, 15, 92);
            doc.text(clientContact, 15, 99);
            // Add items table using autoTable plugin
            const itemsData = [];
            const itemsList = document.getElementById('items-list');
            Array.from(itemsList.children).forEach(itemRow => {
                const description = itemRow.querySelector('.item-description').value || 'Article';
                const quantity = parseFloat(itemRow.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(itemRow.querySelector('.item-unit-price').value) || 0;
                const total = quantity * price;
                itemsData.push([
                    description,
                    quantity.toString(),
                    `${price.toFixed(2)} ${currency}`,
                    `${total.toFixed(2)} ${currency}`
                ]);
            });
            doc.autoTable({
                head: [['Description', 'Quantité', 'Prix unitaire', 'Total']],
                body: itemsData,
                startY: 105,
                theme: 'grid',
                headStyles: {
                    fillColor: [67, 97, 238],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                styles: {
                    fontSize: 10,
                    cellPadding: 3
                },
                columnStyles: {
                    0: { cellWidth: 80 },
                    1: { cellWidth: 25, halign: 'center' },
                    2: { cellWidth: 35, halign: 'right' },
                    3: { cellWidth: 35, halign: 'right' }
                }
            });
            // Add totals
            const finalY = doc.lastAutoTable.finalY;
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            // Subtotal
            doc.text('Sous-total:', 140, finalY + 15);
            doc.text(subtotal, 180, finalY + 15, { align: 'right' });
            // Discount
            if (parseFloat(discountRate) > 0) {
                doc.text(`Remise (${discountRate}%):`, 140, finalY + 23);
                doc.text(discountAmount, 180, finalY + 23, { align: 'right' });
            }
            // Tax
            if (parseFloat(taxRate) > 0) {
                doc.text(`TVA (${taxRate}%):`, 140, finalY + 31);
                doc.text(taxAmount, 180, finalY + 31, { align: 'right' });
            }
            // Total
            doc.setFont(undefined, 'bold');
            doc.text('TOTAL:', 140, finalY + 42);
            doc.text(total, 180, finalY + 42, { align: 'right' });
            // Add notes section with improved HTML processing
            const notesContent = document.getElementById('notes').innerHTML;
            if (notesContent && notesContent.trim() !== '') {
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                // Add a title for notes
                doc.text('Notes:', 15, finalY + 55);
                // Process HTML content for PDF with better formatting
                let yPosition = finalY + 65;
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = notesContent;
                // Process each child node
                const processNode = (node) => {
                    if (node.nodeType === Node.TEXT_NODE) {
                        const text = node.textContent.trim();
                        if (text) {
                            const lines = doc.splitTextToSize(text, 180);
                            lines.forEach(line => {
                                if (yPosition > 280) { // Check if we need a new page
                                    doc.addPage();
                                    yPosition = 20;
                                }
                                doc.text(line, 15, yPosition);
                                yPosition += 7;
                            });
                        }
                    } else if (node.nodeType === Node.ELEMENT_NODE) {
                        let fontStyle = doc.getFont().fontStyle;
                        let fontSize = doc.getFontSize();
                        let textColor = doc.getTextColor();
                        // Apply styles based on element type
                        if (node.tagName === 'B' || node.tagName === 'STRONG') {
                            doc.setFont(undefined, 'bold');
                        } else if (node.tagName === 'I' || node.tagName === 'EM') {
                            doc.setFont(undefined, 'italic');
                        } else if (node.tagName === 'U') {
                            // jsPDF doesn't have direct underline, we'll handle it after
                        }
                        // Process child nodes
                        Array.from(node.childNodes).forEach(child => {
                            processNode(child);
                        });
                        // Add line break after block elements
                        if (['DIV', 'P', 'BR'].includes(node.tagName)) {
                            yPosition += 5;
                        }
                        // Reset styles
                        doc.setFont(undefined, fontStyle);
                        doc.setFontSize(fontSize);
                        // textColor reset is more complex in jsPDF, so we'll skip it for now
                    }
                };
                // Process all nodes
                Array.from(tempDiv.childNodes).forEach(node => {
                    processNode(node);
                });
            }
            // Save the PDF
            doc.save(`devis-${quoteNumber}.pdf`);
            showToast('PDF généré avec succès!');
        }
        function saveQuote() {
            // Get and validate data
            const quoteData = {
                number: document.getElementById('quote-number').value || '',
                date: document.getElementById('quote-date').value || new Date().toISOString().split('T')[0],
                validity: document.getElementById('validity').value || '30',
                currency: document.getElementById('currency').value || 'DT',
                client: {
                    name: document.getElementById('client-name').value || '',
                    address: document.getElementById('client-address').value || '',
                    email: document.getElementById('client-email').value || '',
                    phone: document.getElementById('client-phone').value || ''
                },
                items: [],
                discount: document.getElementById('discount').value || '0',
                tax: document.getElementById('tax').value || '19',
                notes: document.getElementById('notes').innerHTML || '', // Sauvegarder le HTML
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            // Validate items
            const itemsList = document.getElementById('items-list');
            Array.from(itemsList.children).forEach(itemRow => {
                const item = {
                    description: itemRow.querySelector('.item-description').value || 'Article sans nom',
                    quantity: parseFloat(itemRow.querySelector('.item-quantity').value) || 0,
                    price: parseFloat(itemRow.querySelector('.item-unit-price').value) || 0
                };
                // Additional validation
                if (isNaN(item.quantity)) item.quantity = 0;
                if (isNaN(item.price)) item.price = 0;
                quoteData.items.push(item);
            });
            // Calculate totals
            let subtotal = 0;
            quoteData.items.forEach(item => {
                subtotal += item.quantity * item.price;
            });
            const discountAmount = subtotal * parseFloat(quoteData.discount) / 100;
            const taxAmount = (subtotal - discountAmount) * parseFloat(quoteData.tax) / 100;
            const total = subtotal - discountAmount + taxAmount;
            quoteData.subtotal = subtotal.toFixed(2);
            quoteData.discountAmount = discountAmount.toFixed(2);
            quoteData.taxAmount = taxAmount.toFixed(2);
            quoteData.total = total.toFixed(2);
            // Validate quote number
            if (!quoteData.number) {
                showToast('Veuillez saisir un numéro de devis', 'error');
                return;
            }
            // Validate items
            if (quoteData.items.length === 0) {
                showToast('Veuillez ajouter au moins un article', 'error');
                return;
            }
            // Save to Firebase
            try {
                const newQuoteRef = database.ref('quotes').push();
                newQuoteRef.set(quoteData)
                    .then(() => {
                        showToast('Devis enregistré avec succès!');
                        currentQuoteId = newQuoteRef.key;
                        toggleUpdateButton(true);
                    })
                    .catch(error => {
                        console.error("Error details:", quoteData);
                        showToast('Erreur Firebase: ' + error.message, 'error');
                    });
            } catch (e) {
                console.error("Validation error:", e, quoteData);
                showToast('Erreur de validation des données', 'error');
            }
        }
        function updateQuote() {
            if (!currentQuoteId) {
                showToast('Aucun devis sélectionné pour mise à jour', 'error');
                return;
            }
            // Get and validate data
            const quoteData = {
                number: document.getElementById('quote-number').value || '',
                date: document.getElementById('quote-date').value || new Date().toISOString().split('T')[0],
                validity: document.getElementById('validity').value || '30',
                currency: document.getElementById('currency').value || 'DT',
                client: {
                    name: document.getElementById('client-name').value || '',
                    address: document.getElementById('client-address').value || '',
                    email: document.getElementById('client-email').value || '',
                    phone: document.getElementById('client-phone').value || ''
                },
                items: [],
                discount: document.getElementById('discount').value || '0',
                tax: document.getElementById('tax').value || '19',
                notes: document.getElementById('notes').innerHTML || '', // Sauvegarder le HTML
                updatedAt: new Date().toISOString()
            };
            // Validate items
            const itemsList = document.getElementById('items-list');
            Array.from(itemsList.children).forEach(itemRow => {
                const item = {
                    description: itemRow.querySelector('.item-description').value || 'Article sans nom',
                    quantity: parseFloat(itemRow.querySelector('.item-quantity').value) || 0,
                    price: parseFloat(itemRow.querySelector('.item-unit-price').value) || 0
                };
                if (isNaN(item.quantity)) item.quantity = 0;
                if (isNaN(item.price)) item.price = 0;
                quoteData.items.push(item);
            });
            // Calculate totals
            let subtotal = 0;
            quoteData.items.forEach(item => {
                subtotal += item.quantity * item.price;
            });
            const discountAmount = subtotal * parseFloat(quoteData.discount) / 100;
            const taxAmount = (subtotal - discountAmount) * parseFloat(quoteData.tax) / 100;
            const total = subtotal - discountAmount + taxAmount;
            quoteData.subtotal = subtotal.toFixed(2);
            quoteData.discountAmount = discountAmount.toFixed(2);
            quoteData.taxAmount = taxAmount.toFixed(2);
            quoteData.total = total.toFixed(2);
            // Validate quote number
            if (!quoteData.number) {
                showToast('Veuillez saisir un numéro de devis', 'error');
                return;
            }
            // Validate items
            if (quoteData.items.length === 0) {
                showToast('Veuillez ajouter au moins un article', 'error');
                return;
            }
            // Update in Firebase
            try {
                database.ref('quotes/' + currentQuoteId).update(quoteData)
                    .then(() => {
                        showToast('Devis mis à jour avec succès!');
                    })
                    .catch(error => {
                        console.error("Error details:", quoteData);
                        showToast('Erreur Firebase: ' + error.message, 'error');
                    });
            } catch (e) {
                console.error("Validation error:", e, quoteData);
                showToast('Erreur de validation des données', 'error');
            }
        }
        function toggleUpdateButton(show) {
            const saveBtn = document.getElementById('save-quote');
            const updateBtn = document.getElementById('update-quote');
            if (show) {
                saveBtn.style.display = 'none';
                updateBtn.style.display = 'inline-flex';
            } else {
                saveBtn.style.display = 'inline-flex';
                updateBtn.style.display = 'none';
            }
        }
        function openQuotesModal() {
            const modal = document.getElementById('quotesModal');
            const quotesList = document.getElementById('quotes-list');
            // Show modal
            modal.style.display = 'block';
            // Load quotes from Firebase
            quotesList.innerHTML = '<p>Chargement des devis...</p>';
            database.ref('quotes').once('value')
                .then(snapshot => {
                    const quotes = snapshot.val();
                    quotesList.innerHTML = '';
                    if (!quotes) {
                        quotesList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-folder-open"></i>
                                <p>Aucun devis enregistré</p>
                            </div>
                        `;
                        return;
                    }
                    // Convert to array and sort by date
                    const quotesArray = Object.entries(quotes).map(([key, value]) => ({
                        id: key,
                        ...value
                    })).sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
                    // Display each quote
                    quotesArray.forEach(quote => {
                        const quoteItem = document.createElement('div');
                        quoteItem.className = 'quote-item';
                        quoteItem.innerHTML = `
                            <div class="quote-item-header">
                                <span class="quote-item-number">${quote.number || 'Sans numéro'}</span>
                                <span class="quote-item-date">${new Date(quote.date).toLocaleDateString('fr-FR')}</span>
                            </div>
                            <div class="quote-item-client">${quote.client.name || 'Client non spécifié'}</div>
                            <div class="quote-item-total">Total: ${quote.total} ${quote.currency}</div>
                            <div class="quote-item-actions">
                                <button class="btn btn-primary btn-xs load-quote-btn" data-id="${quote.id}">
                                    <i class="fas fa-edit"></i> Modifier
                                </button>
                                <button class="btn btn-danger btn-xs delete-quote-btn" data-id="${quote.id}">
                                    <i class="fas fa-trash"></i> Supprimer
                                </button>
                            </div>
                        `;
                        quotesList.appendChild(quoteItem);
                    });
                    // Add event listeners to buttons
                    document.querySelectorAll('.load-quote-btn').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const quoteId = this.getAttribute('data-id');
                            loadQuote(quoteId);
                        });
                    });
                    document.querySelectorAll('.delete-quote-btn').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const quoteId = this.getAttribute('data-id');
                            deleteQuote(quoteId);
                        });
                    });
                    // Add click event to load quote
                    document.querySelectorAll('.quote-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const quoteId = this.querySelector('.load-quote-btn').getAttribute('data-id');
                            loadQuote(quoteId);
                        });
                    });
                })
                .catch(error => {
                    quotesList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Erreur lors du chargement des devis</p>
                        </div>
                    `;
                    console.error('Firebase error:', error);
                });
        }
        function closeQuotesModal() {
            document.getElementById('quotesModal').style.display = 'none';
        }
        function loadQuote(quoteId) {
            database.ref('quotes/' + quoteId).once('value')
                .then(snapshot => {
                    const quote = snapshot.val();
                    if (!quote) {
                        showToast('Devis non trouvé', 'error');
                        return;
                    }
                    currentQuoteId = quoteId;
                    // Fill form fields with quote data
                    document.getElementById('quote-number').value = quote.number || '';
                    document.getElementById('quote-date').value = quote.date || new Date().toISOString().split('T')[0];
                    document.getElementById('validity').value = quote.validity || '30';
                    document.getElementById('currency').value = quote.currency || 'DT';
                    // Client information
                    document.getElementById('client-name').value = quote.client?.name || '';
                    document.getElementById('client-address').value = quote.client?.address || '';
                    document.getElementById('client-email').value = quote.client?.email || '';
                    document.getElementById('client-phone').value = quote.client?.phone || '';
                    // Taxes and discounts
                    document.getElementById('discount').value = quote.discount || '0';
                    document.getElementById('tax').value = quote.tax || '19';
                    document.getElementById('notes').innerHTML = quote.notes || ''; // Charger le HTML
                    // Items
                    const itemsList = document.getElementById('items-list');
                    itemsList.innerHTML = '';
                    if (quote.items && quote.items.length > 0) {
                        quote.items.forEach((item, index) => {
                            const itemRow = document.createElement('div');
                            itemRow.className = 'item-row';
                            itemRow.innerHTML = `
                                <div class="item-desc">
                                    <input type="text" class="item-description" placeholder="Description de l'article ${index + 1}" value="${item.description || ''}">
                                </div>
                                <div class="item-qty">
                                    <input type="number" class="item-quantity" value="${item.quantity || 0}" min="1">
                                </div>
                                <div class="item-price">
                                    <input type="number" class="item-unit-price" value="${item.price || 0}" min="0" step="0.01">
                                </div>
                                <div class="item-total">
                                    <span class="item-total-value">${((item.quantity || 0) * (item.price || 0)).toFixed(2)}</span> <span class="currency">${quote.currency || 'DT'}</span>
                                </div>
                                <div class="item-action">
                                    <button class="btn btn-danger btn-sm remove-item"><i class="fas fa-trash"></i></button>
                                </div>
                            `;
                            itemsList.appendChild(itemRow);
                            // Add events
                            const quantityInput = itemRow.querySelector('.item-quantity');
                            const priceInput = itemRow.querySelector('.item-unit-price');
                            const calculateTotal = () => {
                                const quantity = parseFloat(quantityInput.value) || 0;
                                const price = parseFloat(priceInput.value) || 0;
                                const total = quantity * price;
                                itemRow.querySelector('.item-total-value').textContent = total.toFixed(2);
                                updatePreview();
                            };
                            quantityInput.addEventListener('input', calculateTotal);
                            priceInput.addEventListener('input', calculateTotal);
                            itemRow.querySelector('.remove-item').addEventListener('click', function() {
                                itemsList.removeChild(itemRow);
                                updatePreview();
                            });
                        });
                    } else {
                        // Add empty item if no items exist
                        addNewItem();
                    }
                    updatePreview();
                    toggleUpdateButton(true);
                    closeQuotesModal();
                    showToast('Devis chargé avec succès!');
                })
                .catch(error => {
                    console.error('Error loading quote:', error);
                    showToast('Erreur lors du chargement du devis', 'error');
                });
        }
        function deleteQuote(quoteId) {
            if (confirm('Voulez-vous vraiment supprimer ce devis? Cette action est irréversible.')) {
                database.ref('quotes/' + quoteId).remove()
                    .then(() => {
                        if (currentQuoteId === quoteId) {
                            currentQuoteId = null;
                            toggleUpdateButton(false);
                        }
                        showToast('Devis supprimé avec succès!');
                        openQuotesModal(); // Refresh the list
                    })
                    .catch(error => {
                        console.error('Error deleting quote:', error);
                        showToast('Erreur lors de la suppression du devis', 'error');
                    });
            }
        }
        function resetForm() {
            if (confirm('Voulez-vous vraiment réinitialiser le formulaire? Toutes les modifications non enregistrées seront perdues.')) {
                document.getElementById('quote-number').value = '';
                document.getElementById('quote-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('validity').value = '30';
                document.getElementById('currency').value = 'DT';
                document.getElementById('client-name').value = '';
                document.getElementById('client-address').value = '';
                document.getElementById('client-email').value = '';
                document.getElementById('client-phone').value = '';
                document.getElementById('discount').value = '0';
                document.getElementById('tax').value = '19';
                document.getElementById('notes').innerHTML = '';
                document.getElementById('items-list').innerHTML = '';
                addNewItem();
                currentQuoteId = null;
                toggleUpdateButton(false);
                showToast('Formulaire réinitialisé!');
            }
        }
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = toast.querySelector('.toast-message');
            toast.className = 'toast'; // Reset classes
            toast.classList.add(type);
            // Set icon based on type
            const icon = toast.querySelector('i');
            if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle';
            } else if (type === 'warning') {
                icon.className = 'fas fa-exclamation-triangle';
            } else {
                icon.className = 'fas fa-check-circle';
            }
            toastMessage.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
